# catch-all.yml
#
# Primary catch-all workflow.
# Triggers on every branch and every event so that all repositories that sync
# this .github directory are covered automatically.
#
# When dispatched manually a 'product' must be selected.  The workflow then:
#   1. Tests scripts/sync.py (must exit 0).
#   2. Checks whether .github/products/<product>-start.yaml exists.
#      • EXISTS   → executes the product jobs inside the named GitHub Environment
#                   (PRODUCT env-var is set to the product name).
#                   TODO (admin): create the '<product>' GitHub Environment and
#                   add PRODUCT=<product> as an environment variable before use.
#      • MISSING  → creates branch 'onboarding_<product>' and scaffolds the
#                   product-start.yaml + a default catch-all workflow for it.

name: Catch-All

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"
  workflow_dispatch:
    inputs:
      product:
        description: "Select a product to execute"
        required: true
        type: choice
        options:
          - loudbinary

jobs:
  # ── 1. Always run: validate the sync script ────────────────────────────────
  test-sync:
    name: Test sync.py
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify sync script exits cleanly
        run: python scripts/sync.py

  # ── 2. Manual dispatch only: decide what to do with the chosen product ─────
  check-product:
    name: Check product configuration
    runs-on: ubuntu-latest
    needs: test-sync
    if: github.event_name == 'workflow_dispatch'
    outputs:
      product: ${{ steps.check.outputs.product }}
      exists:  ${{ steps.check.outputs.exists }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for product-start.yaml
        id: check
        run: |
          PRODUCT="${{ inputs.product }}"
          echo "product=${PRODUCT}" >> "$GITHUB_OUTPUT"
          if [ -f ".github/products/${PRODUCT}-start.yaml" ]; then
            echo "exists=true"  >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

  # ── 3a. Product file EXISTS → execute in the product's environment ─────────
  execute-product:
    name: Execute – ${{ needs.check-product.outputs.product }}
    runs-on: ubuntu-latest
    needs: check-product
    if: needs.check-product.outputs.exists == 'true'
    # GitHub Environment named after the product provides secrets/variables.
    # TODO (admin): create the environment and set PRODUCT=<product> on it.
    environment: ${{ needs.check-product.outputs.product }}
    env:
      PRODUCT: ${{ needs.check-product.outputs.product }}
    steps:
      - uses: actions/checkout@v4

      - name: Run sync script
        run: python scripts/sync.py

      - name: Execute product start configuration
        run: |
          echo "Executing product: ${PRODUCT}"
          echo "Config: .github/products/${PRODUCT}-start.yaml"
          # The steps defined in the product-start.yaml are executed here.
          # Extend this step (or use a reusable workflow) to parse and run them.

  # ── 3b. Product file MISSING → scaffold onboarding branch ─────────────────
  onboard-product:
    name: Onboard – ${{ needs.check-product.outputs.product }}
    runs-on: ubuntu-latest
    needs: check-product
    if: needs.check-product.outputs.exists == 'false'
    steps:
      - uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create onboarding branch and scaffold product files
        env:
          PRODUCT: ${{ needs.check-product.outputs.product }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git checkout -b "onboarding_${PRODUCT}"

          mkdir -p .github/products .github/workflows scripts

          # ── default product-start.yaml ──────────────────────────────────
          cat > ".github/products/${PRODUCT}-start.yaml" << YAML
          product: ${PRODUCT}
          description: ${PRODUCT} product start configuration

          # TODO (admin): create the '${PRODUCT}' GitHub Environment and set
          # PRODUCT=${PRODUCT} as an environment variable on it.
          jobs:
            - name: sync
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Run sync script
                  run: python scripts/sync.py
          YAML

          # ── default catch-all workflow for the new product ──────────────
          cat > ".github/workflows/${PRODUCT}-catch-all.yml" << YAML
          name: ${PRODUCT} Catch-All
          on:
            push:
              branches: ["**"]
            pull_request:
              branches: ["**"]
            workflow_dispatch: {}
          jobs:
            sync:
              name: Sync
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Run sync script (first action in synced repository)
                  run: python scripts/sync.py
          YAML

          git add .github/products .github/workflows scripts
          git commit -m "chore: scaffold onboarding for ${PRODUCT}"
          git push origin "onboarding_${PRODUCT}"
